<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <meta name="author" content="Yusuf Musleh">
    <meta name="description" content="Restructuring Server-Client implementation and introducing new messaging protocol.">
    <link rel="alternate" href="/atom.xml" type="application/atom+xml">
    <link rel="stylesheet" href="/style.css" type="text/css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <title>Yusuf Musleh | mmar - Devlog 2</title>

<script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getNextSurveyStep onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_e9dXJZIsCVdHzVkBKZGXklKjLGnmtRLXc4xZEaXUJg2',{api_host:'https://us.i.posthog.com', person_profiles: 'identified_only'
        })
</script>

</head>

  <body>
    <header>
      <h1><a href="/">Yusuf Musleh</a></h1>
      <nav>
        <h2>thoughts and devlogs</h2>
        <ul>
          <li><h2><a href="/writings.html">Writings</a></h2></li>
          <li><h2><a href="/archive.html">Archive</a></h2></li>
          <li><h2><a href="/tags/">Tags</a></h2></li>
        </ul>
      </nav>
    </header>

    <main>
    

  
  <h2>mmar - Devlog 2</h2>
  

  <aside>
    <p>published on 2024-10-25

    
    · tagged with
      
        <a href="/tags/devlog.html">#devlog</a>, 
        <a href="/tags/golang.html">#golang</a>, 
        <a href="/tags/http.html">#http</a>, 
        <a href="/tags/mmar.html">#mmar</a> and 
        <a href="/tags/tunnel.html">#tunnel</a>
    
    </p>
  </aside>

  <p><em>This post is part of a devlog series documenting my progress building <code>mmar</code>, a cross-platform tunnel that exposes your localhost to the world. If you&rsquo;d like to follow along from the beginning, you can find all the devlogs <a href="/tags/mmar.html">here</a>.</em></p>
<h2>Progress Update</h2>
<p>Since my last devlog, there’s been quite a bit of updates. When I started off with the project, my intention was to be a scrappy, discover what I need to implement as I build and use <code>mmar</code>, then go back and refactor, as opposed to optimizing everything from the beginning.</p>
<p>This approach really helped me understand exactly <em>why</em> I need to implement something, rather than just building it because I heard/read about it somewhere. It’s also great seeing your code evolve.</p>
<p>Let’s go through the updates made, there’s a lot more code in this devlog.</p>
<h2>Restructured Server-Client Implementation</h2>
<p>You may remember from the <a href="/mmar-devlog-001.html">previous devlog</a>, the setup I had was that the <code>mmar</code> server gets requests, forwards them to the <code>mmar</code> client, which then gets a response from localhost and sends it back. This worked great, however there was a bunch of assumptions I was making in this implementation. </p>
<p>The main assumption I had was that server would <strong>only receive HTTP responses</strong> from the client and that the client would <strong>only receive HTTP requests</strong> from the server.</p>
<p>This quickly became an issue when I needed to handle cases other than the happy path of request —&gt; response. For example, I wanted the server to know when the client disconnects or is shutdown. Limiting myself to this request-response assumption made it quite rigid to implement different functionalities and communications between the server and client. I found myself hacking around that, creating &ldquo;responses&rdquo; that represented different states, all to conform to my assumption.</p>
<p>This is where the need to have a more flexible/extendible protocol that allows 2-way communication between the server and client without the limitations of requests/responses. I discuss the details of the message protocol in the next section (it’s pretty basic :D), but here I will go through how I restructured the server and client to handle different types of messages being sent to each other.</p>
<p>First, I make a distinction between <code>ClientTunnel</code> (tunnel to the client) and <code>ServerTunnel</code> (tunnel to the server), and embed the shared fields in the structs, previously it was just <code>Tunnel</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">Tunnel</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">id</span><span class="w">   </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">conn</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span>
<span class="p">}</span>

<span class="c1">// Tunnel to Client</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ClientTunnel</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Tunnel</span>
<span class="w">    </span><span class="nx">incomingChannel</span><span class="w"> </span><span class="kd">chan</span><span class="w"> </span><span class="nx">IncomingRequest</span>
<span class="w">    </span><span class="nx">outgoingChannel</span><span class="w"> </span><span class="kd">chan</span><span class="w"> </span><span class="nx">TunnelMessage</span>
<span class="p">}</span>

<span class="c1">// Tunnel to Server</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ServerTunnel</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Tunnel</span>
<span class="p">}</span>
</code></pre></div>

<p>Next, I created an interface that tunnels would implement, this allows the tunnels to handle different types messages:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">TunnelInterface</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">processTunnelMessages</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>And moved the logic for receiving messages to the <code>Tunnel</code> struct:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">Tunnel</span><span class="p">)</span><span class="w"> </span><span class="nx">receiveMessage</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nx">TunnelMessage</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">msgReader</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">conn</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Read and deserialize tunnel message data</span>
<span class="w">    </span><span class="nx">tunnelMessage</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">TunnelMessage</span><span class="p">{}</span>
<span class="w">    </span><span class="nx">deserializeErr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tunnelMessage</span><span class="p">.</span><span class="nx">deserializeMessage</span><span class="p">(</span><span class="nx">msgReader</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">tunnelMessage</span><span class="p">,</span><span class="w"> </span><span class="nx">deserializeErr</span>
<span class="p">}</span>
</code></pre></div>

<p>Making this change allowed for the decoupling of processing <em>messages</em> and processing <em>requests/responses</em>. Now there is one place (in each of the client and server) that handles reading from the TCP connection, simplifying the logic and preventing multiple goroutines stepping on each others toes reading data from the same connection.</p>
<h3>Handling Messages on Server</h3>
<p>On the server side when dealing with messages coming from a client, it looks like this:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">ct</span><span class="w"> </span><span class="o">*</span><span class="nx">ClientTunnel</span><span class="p">)</span><span class="w"> </span><span class="nx">processTunnelMessages</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">tunnelMsg</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ct</span><span class="p">.</span><span class="nx">receiveMessage</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Failed to receive message from client tunnel: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="nx">tunnelMsg</span><span class="p">.</span><span class="nx">msgType</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">RESPONSE</span><span class="p">:</span>
<span class="w">            </span><span class="nx">ct</span><span class="p">.</span><span class="nx">outgoingChannel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">tunnelMsg</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">LOCALHOST_NOT_RUNNING</span><span class="p">:</span>
<span class="w">            </span><span class="c1">// Create a response for Tunnel connected but localhost not running</span>
<span class="w">            </span><span class="nx">resp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">TunnelErrStateResp</span><span class="p">(</span><span class="nx">LOCALHOST_NOT_RUNNING</span><span class="p">)</span>
<span class="w">            </span><span class="c1">// Writing response to buffer to tunnel it back</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">responseBuff</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
<span class="w">            </span><span class="nx">resp</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">responseBuff</span><span class="p">)</span>
<span class="w">            </span><span class="nx">notRunningMsg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">TunnelMessage</span><span class="p">{</span><span class="nx">msgType</span><span class="p">:</span><span class="w"> </span><span class="nx">RESPONSE</span><span class="p">,</span><span class="w"> </span><span class="nx">msgData</span><span class="p">:</span><span class="w"> </span><span class="nx">responseBuff</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">()}</span>
<span class="w">            </span><span class="nx">ct</span><span class="p">.</span><span class="nx">outgoingChannel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">notRunningMsg</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">CLIENT_DISCONNECT</span><span class="p">:</span>
<span class="w">            </span><span class="nx">ct</span><span class="p">.</span><span class="nb">close</span><span class="p">()</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Notice how this allows us to easily add new types of messages and logic to handle them.</p>
<h3>Handling Messages on Client</h3>
<p>Similarly on the client side, we also deal with different types of messages from the server:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">st</span><span class="w"> </span><span class="o">*</span><span class="nx">ServerTunnel</span><span class="p">)</span><span class="w"> </span><span class="nx">processTunnelMessages</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span><span class="w"> </span><span class="c1">// Client gracefully shutdown</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="k">default</span><span class="p">:</span>
<span class="w">            </span><span class="nx">tunnelMsg</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">st</span><span class="p">.</span><span class="nx">receiveMessage</span><span class="p">()</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&quot;Tunnel connection closed from Server. Exiting...&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">net</span><span class="p">.</span><span class="nx">ErrClosed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&quot;Tunnel connection disconnected from Server. Existing...&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Failed to receive message from server tunnel: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="nx">tunnelMsg</span><span class="p">.</span><span class="nx">msgType</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nx">REQUEST</span><span class="p">:</span>
<span class="w">                </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Got REQUEST TUNNEL MESSAGE\n&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="k">go</span><span class="w"> </span><span class="nx">st</span><span class="p">.</span><span class="nx">handleRequestMessage</span><span class="p">(</span><span class="nx">tunnelMsg</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Currently, I only handle <code>REQUEST</code> messages, however as you can see, it’s trivial now to handle new cases in the future as needed.</p>
<h2>Introduced Tunnel Message Protocol</h2>
<p>Now that we’ve seen the mechanics of how messaging is handled, let’s go through the messaging protocol itself and how messages are represented.</p>
<p>Currently the protocol is quite basic, it consists of 3 components: 1. Message type prefix, 2. Length of message data bytes and 3. The actual data bytes of the message. They are delimited by a new line character <code>\n</code>. It looks something like this:</p>
<div class="codehilite"><pre><span></span><code>REQUEST
110
[23 25 52 38 95 39 ...]
</code></pre></div>

<p>This represents a <strong>request</strong> message. </p>
<div class="codehilite"><pre><span></span><code>CLIENT_DISCONNECT
0
[]
</code></pre></div>

<p>This represents a <strong>client disconnect</strong> message. </p>
<p>You get the idea. Whenever I need to introduce a new type of message either from the client or the server, I can just add it to the protocol. Here’s how the code looks like for defining the messages:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">HEARTBEAT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="nx">REQUEST</span>
<span class="w">    </span><span class="nx">RESPONSE</span>
<span class="w">    </span><span class="nx">CLIENT_DISCONNECT</span>
<span class="w">    </span><span class="nx">LOCALHOST_NOT_RUNNING</span>
<span class="p">)</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">MESSAGE_MAPPING</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
<span class="w">    </span><span class="nx">HEARTBEAT</span><span class="p">:</span><span class="w">             </span><span class="s">&quot;HEARTBEAT&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">REQUEST</span><span class="p">:</span><span class="w">               </span><span class="s">&quot;REQUEST&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">RESPONSE</span><span class="p">:</span><span class="w">              </span><span class="s">&quot;RESPONSE&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">CLIENT_DISCONNECT</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;CLIENT_DISCONNECT&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">LOCALHOST_NOT_RUNNING</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;LOCALHOST_NOT_RUNNING&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">TunnelMessage</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">msgType</span><span class="w"> </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">msgData</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>
</code></pre></div>

<p>To serialize and deserialize the message in the format described above, I added serializer/deserializer functions to the <code>TunnelMessage</code> struct:</p>
<h3>Serializing Messages</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tm</span><span class="w"> </span><span class="o">*</span><span class="nx">TunnelMessage</span><span class="p">)</span><span class="w"> </span><span class="nx">serializeMessage</span><span class="p">()</span><span class="w"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">serializedMsg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[][]</span><span class="kt">byte</span><span class="p">{}</span>

<span class="w">    </span><span class="c1">// Determine message type to add prefix</span>
<span class="w">    </span><span class="nx">msgType</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">MESSAGE_MAPPING</span><span class="p">[</span><span class="nx">tm</span><span class="p">.</span><span class="nx">msgType</span><span class="p">]</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">msgType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Invalid TunnelMessage type: %v:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tm</span><span class="p">.</span><span class="nx">msgType</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Add the message type</span>
<span class="w">    </span><span class="nx">serializedMsg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">serializedMsg</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">msgType</span><span class="p">))</span>
<span class="w">    </span><span class="c1">// Add message data bytes length</span>
<span class="w">    </span><span class="nx">serializedMsg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">serializedMsg</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">tm</span><span class="p">.</span><span class="nx">msgData</span><span class="p">))))</span>
<span class="w">    </span><span class="c1">// Add the message data</span>
<span class="w">    </span><span class="nx">serializedMsg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">serializedMsg</span><span class="p">,</span><span class="w"> </span><span class="nx">tm</span><span class="p">.</span><span class="nx">msgData</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Combine all the data separated by new lines</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">serializedMsg</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)),</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<h3>Deserializing Messages</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tm</span><span class="w"> </span><span class="o">*</span><span class="nx">TunnelMessage</span><span class="p">)</span><span class="w"> </span><span class="nx">readMessageData</span><span class="p">(</span><span class="nx">length</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">reader</span><span class="w"> </span><span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">msgData</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadFull</span><span class="p">(</span><span class="nx">reader</span><span class="p">,</span><span class="w"> </span><span class="nx">msgData</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Failed to read all Msg Data: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">msgData</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tm</span><span class="w"> </span><span class="o">*</span><span class="nx">TunnelMessage</span><span class="p">)</span><span class="w"> </span><span class="nx">deserializeMessage</span><span class="p">(</span><span class="nx">reader</span><span class="w"> </span><span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">msgPrefix</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">reader</span><span class="p">.</span><span class="nx">ReadString</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">msgLengthStr</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">reader</span><span class="p">.</span><span class="nx">ReadString</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">msgLength</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">msgLengthStr</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">msgLengthStr</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Could not parse message length: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">msgLengthStr</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">msgType</span><span class="w"> </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">msgData</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tm</span><span class="p">.</span><span class="nx">readMessageData</span><span class="p">(</span><span class="nx">msgLength</span><span class="p">,</span><span class="w"> </span><span class="nx">reader</span><span class="p">)</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">msgPrefix</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;HEARTBEAT\n&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="nx">msgType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">HEARTBEAT</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;REQUEST\n&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="nx">msgType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">REQUEST</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;RESPONSE\n&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="nx">msgType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">RESPONSE</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;CLIENT_DISCONNECT\n&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="nx">msgType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">CLIENT_DISCONNECT</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;LOCALHOST_NOT_RUNNING\n&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="nx">msgType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">LOCALHOST_NOT_RUNNING</span>
<span class="w">    </span><span class="k">default</span><span class="p">:</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Invalid TunnelMessage prefix: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">msgPrefix</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">tm</span><span class="p">.</span><span class="nx">msgType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">msgType</span>
<span class="w">    </span><span class="nx">tm</span><span class="p">.</span><span class="nx">msgData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">msgData</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<h3>Sending/Receiving Messages</h3>
<p>Once we have serializing/deserializing implemented, sending/receiving messages becomes trivial:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">Tunnel</span><span class="p">)</span><span class="w"> </span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">tunnelMsg</span><span class="w"> </span><span class="nx">TunnelMessage</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Serialize tunnel message data</span>
<span class="w">    </span><span class="nx">serializedMsg</span><span class="p">,</span><span class="w"> </span><span class="nx">serializeErr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tunnelMsg</span><span class="p">.</span><span class="nx">serializeMessage</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">serializeErr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">serializeErr</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">serializedMsg</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">Tunnel</span><span class="p">)</span><span class="w"> </span><span class="nx">receiveMessage</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nx">TunnelMessage</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">msgReader</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">conn</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Read and deserialize tunnel message data</span>
<span class="w">    </span><span class="nx">tunnelMessage</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">TunnelMessage</span><span class="p">{}</span>
<span class="w">    </span><span class="nx">deserializeErr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tunnelMessage</span><span class="p">.</span><span class="nx">deserializeMessage</span><span class="p">(</span><span class="nx">msgReader</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">tunnelMessage</span><span class="p">,</span><span class="w"> </span><span class="nx">deserializeErr</span>
<span class="p">}</span>
</code></pre></div>

<h3>Thoughts on Optimizing</h3>
<p>As you’ve seen, the protocol is quite simple. The message type (prefix) is represented as a string, and that string differs in length for different message types. That is an awful lot of space to just represent the type of the message, 7 bytes in the case of <code>REQUEST</code>.</p>
<p>A better approach would be to use a single byte (8-bits), which gives us the possibility to represent (2<sup>8</sup>) 256 different types of values, which I’d like to assume would be more than enough to represent all the possible different types of messages in the protocol between the server and client.</p>
<p>The currently implementation is fine for now, however I will likely revisit it soon to optimize it.</p>
<h2>Handled Various Actions/Edge Cases</h2>
<p>The last thing I wanted to mention that I worked on was handling various cases that could occur in the lifecycle of <code>mmar server</code> or <code>mmar client</code>. This included scenarios like:</p>
<ul>
<li>Server handling when a client disconnects</li>
<li>Client handling when the server disconnects</li>
<li>Gracefully handling shutdown of client</li>
<li>Gracefully handling shutdown of the server</li>
<li>What happens when both the server and client are up, running and connected, but nothing is running locally to expose?</li>
</ul>
<p>Basically the changes included improvements to the stability of both the server and client. In addition to making sure to shutdown unused resources (such as goroutines) if they are no longer needed, eg when a client disconnects, we no longer need the goroutine to process messages from it.</p>
<h2>Thanks!</h2>
<p>That’s it for this edition of the devlog, hope you enjoyed reading it. Now back to building, see you in the next one!</p>


    </main>

    <footer>
      <p>
      Find me on
        <a href="https://github.com/yusuf-musleh">Github</a> -
        <a href="https://www.linkedin.com/in/yusufmusleh/">Linkedin</a> - 
        <a href="https://twitter.com/YusufMusleh">X</a>
      <br>
      This website was built with <a href="https://github.com/venthur/blag">blag</a>.
      </p>
    </footer>
  </body>

</html>